var T=Object.defineProperty;var V=(r,n,t)=>n in r?T(r,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[n]=t;var i=(r,n,t)=>(V(r,typeof n!="symbol"?n+"":n,t),t);import{B as h,C as a}from"./index-DPcE-bz1.js";import{B as d,g as E,s as $,p as y,d as b,a as B,b as N,L as C,H as M,m as R,h as k,c as q,u as j,e as D,f as Q,i as W,j as U,k as z}from"./asyncRaceApi-DKtDc7ni.js";const H="_page_x4yqz_1",X="_main_x4yqz_1",A="_carForm_x4yqz_13",O="_buttons_x4yqz_19",G="_carQuantity_x4yqz_24",J="_pageInfo_x4yqz_32",g={page:H,main:X,carForm:A,buttons:O,carQuantity:G,pageInfo:J},K="_input_1dh2a_1",Y={input:K};class x extends h{constructor(t,e,s,o,c,u){super({tagName:"input",className:Y.input,type:t,name:e,required:s,disabled:o,minLength:c,pattern:u});i(this,"type");this.type=t}getInputType(){return this.type}getInputValue(){return this.element.value}setInputValue(t){this.element.value=t}focus(){this.element.focus()}setParameters(t){super.setParameters(t);const{type:e,name:s,required:o,disabled:c,minLength:u,pattern:l}=t;e&&(this.element.type=e),s&&(this.element.name=s),o&&(this.element.required=o),c&&(this.element.disabled=c),u&&(this.element.minLength=u),l&&(this.element.pattern=l)}}const Z="_form_ocdoo_1",tt="_button_ocdoo_6",P={form:Z,button:tt};class S extends h{constructor(t,e,s){const o=[new x("text","Car name",!0,e,2),new x("color","",!0,e)];super({tagName:"form",className:P.form},...o,new d(`${P.button} ${s}`,"submit",t,void 0,e));i(this,"inputs");this.inputs=o,this.initListeners()}resetInputs(){this.children.forEach(t=>{const e=t.getElement();e instanceof HTMLInputElement&&(e.type==="color"?e.value="#000000":e.value="")})}disableForm(){this.children.forEach(t=>{const e=t.getElement();(e instanceof HTMLInputElement||e instanceof HTMLButtonElement)&&(e.disabled=!0),e instanceof HTMLInputElement&&(e.type==="color"?e.value="#000000":e.value="")})}enableForm(){this.children.forEach(t=>{const e=t.getElement();(e instanceof HTMLInputElement||e instanceof HTMLButtonElement)&&(e.disabled=!1)})}getCarObjectFromInputs(){return this.inputs.reduce((e,s)=>(s.getInputType()==="color"&&(e.color=s.getInputValue()),s.getInputType()==="text"&&(e.name=s.getInputValue()),e),{})}initListeners(){this.element.onsubmit=()=>!1}}class et extends S{constructor(){super("Create a car")}initListeners(){super.initListeners(),this.element.addEventListener("submit",async()=>{const n=this.getCarObjectFromInputs(),t=await E();let e=1;t&&t.length&&(e=t[t.length-1].id+1),n.id=e,this.element.dispatchEvent(new CustomEvent(a.CreateCar,{bubbles:!0,detail:{car:n}}))})}}const nt="_updateButton_1drd0_1",st={updateButton:nt};class it extends S{constructor(){super("Update a car",!0,st.updateButton);i(this,"currentCarId")}setCurrentCarId(t){this.currentCarId=t}deleteCurrentCarId(){delete this.currentCarId}initListeners(){super.initListeners(),this.element.addEventListener("submit",async()=>{const t=this.getCarObjectFromInputs();t.id=this.currentCarId,this.element.dispatchEvent(new CustomEvent(a.UpdateCar,{bubbles:!0,detail:{car:t}}))})}}function at(r){const n=window.getComputedStyle(r);return new WebKitCSSMatrix(n.transform).m41}class rt extends h{constructor(n,t="",e){super({tagName:"img",className:e,src:n,alt:t})}setParameters(n){super.setParameters(n);const{alt:t,src:e}=n;e&&(this.element.src=e),t?this.element.alt=t:this.element.alt=""}}const ot="_info_1qfkk_1",ct="_buttons_1qfkk_9",ut="_svg_1qfkk_14",lt="_carName_1qfkk_24",dt="_road_1qfkk_31",ht="_finish_1qfkk_43",p={info:ot,buttons:ct,svg:ut,carName:lt,road:dt,finish:ht};class mt extends d{constructor(){super("","button","Delete"),this.initListeners()}initListeners(){this.element.addEventListener("click",()=>{this.element.dispatchEvent(new CustomEvent(a.TriggerDeleteCar,{bubbles:!0}))})}}class pt extends d{constructor(){super("","button","Select"),this.initListeners()}initListeners(){this.element.addEventListener("click",()=>{this.element.dispatchEvent(new CustomEvent(a.TriggerUpdateCarInfo,{bubbles:!0}))})}}const Ct="_button_1o4jr_1",gt="_primary_1o4jr_18",bt="_secondary_1o4jr_35",ft={button:Ct,primary:gt,secondary:bt};class vt extends d{constructor(){super(ft.button,"button","Start"),this.initListeners()}initListeners(){this.element.addEventListener("click",()=>{this.element.dispatchEvent(new CustomEvent(a.StartCar,{bubbles:!0}))})}}const wt="_button_49jio_1",_t="_primary_49jio_18",Lt="_secondary_49jio_35",yt={button:wt,primary:_t,secondary:Lt};class Et extends d{constructor(){super(yt.button,"button","Stop",void 0,!0),this.initListeners()}initListeners(){this.element.addEventListener("click",()=>{this.element.dispatchEvent(new CustomEvent(a.StopCar,{bubbles:!0}))})}}const It=""+new URL("car-JMzejMHG.svg",import.meta.url).href,Bt=""+new URL("finish-C1N534Yl.webp",import.meta.url).href;class xt extends h{constructor(t){const{id:e,name:s,color:o}=t,c=$(`<svg width="100%" height="100%" 
      viewBox="0 0 100 45"><use href="${It}#car"></use></svg>
      `,p.svg),u=y(s||"No Name",p.carName);super({tagName:"div",className:p.info},u);i(this,"id");i(this,"carSvgComp");i(this,"nameComp");i(this,"color");i(this,"name");i(this,"translateXShift",0);i(this,"animationRequestID");i(this,"selectButton");i(this,"deleteButton");i(this,"startButton");i(this,"stopButton");this.selectButton=new pt,this.deleteButton=new mt,this.startButton=new vt,this.stopButton=new Et,this.addChildrenComponents("end",b(p.buttons,this.selectButton,this.deleteButton),b(p.buttons,this.startButton,this.stopButton),c,b(p.road),new rt(Bt,"finish",p.finish)),this.id=e,this.color=o,this.name=s,this.carSvgComp=c,this.nameComp=u,this.setCarColor(o),this.initListeners()}setCarColor(t){this.carSvgComp.getElement().style.fill=t,this.color=t}setCarName(t){this.nameComp.setTextContent(t),this.name=t}getCarInfo(){return{id:this.id,color:this.color,name:this.name}}setCarInfo(t){const{color:e,name:s}=t;this.setCarColor(e),this.setCarName(s)}disableChangeCarButtons(){this.selectButton.disable(),this.deleteButton.disable()}enableChangeCarButtons(){this.selectButton.enable(),this.deleteButton.enable()}async startCar(){return this.disableChangeCarButtons(),this.startButton.disable(),this.stopButton.enable(),B(this.id,"started")}async driveCar(t){const e=t.distance/t.velocity/1e3*60,s=this.getElementWidth();this.translateXShift=(s-this.carSvgComp.getElementWidth()-this.getElementWidth()*.01)/e,this.animationRequestID=requestAnimationFrame(this.animateCarMovement.bind(this));const o=await N(this.id);if(cancelAnimationFrame(this.animationRequestID),!o.success)throw Error("car got broken");return{car:this.getCarInfo(),engineParams:t}}async animateCarMovement(){const t=at(this.carSvgComp.getElement());this.carSvgComp.getElement().style.transform=`translateX(${t+this.translateXShift}px)`,this.animationRequestID=requestAnimationFrame(this.animateCarMovement.bind(this))}async stopCar(){this.stopButton.disable(),await B(this.id,"stopped"),this.animationRequestID&&cancelAnimationFrame(this.animationRequestID),this.carSvgComp.getElement().style.transform="translateX(0)",this.startButton.enable(),this.enableChangeCarButtons()}initListeners(){this.initTriggerUpdateCarInfoListener(),this.initTriggerDeleteCarListener(),this.initTriggerStartCarListener(),this.initTriggerStopCarListener()}initTriggerUpdateCarInfoListener(){this.element.addEventListener(a.TriggerUpdateCarInfo,()=>{this.element.dispatchEvent(new CustomEvent(a.FocusUpdateCarInput,{bubbles:!0,detail:{car:this.getCarInfo()}}))})}initTriggerDeleteCarListener(){this.element.addEventListener(a.TriggerDeleteCar,()=>{this.element.dispatchEvent(new CustomEvent(a.DeleteCar,{bubbles:!0,detail:{car:this.getCarInfo()}}))})}initTriggerStartCarListener(){this.element.addEventListener(a.StartCar,async()=>{const t=await this.startCar();t&&this.driveCar(t)})}initTriggerStopCarListener(){this.element.addEventListener(a.StopCar,async()=>{await this.stopCar()})}}const Pt="_list_ua2qy_1",St={list:Pt};class Ft extends h{constructor(n){super({tagName:"div",className:St.list}),this.updateChildren(n,C)}async updateChildren(n,t){this.removeChildrenComponents();const e=await E(n,t),s=[];e&&e.forEach(o=>s.push(new xt(o))),this.addChildrenComponents("end",...s)}findChildComponentById(n){return this.children.find(e=>e.id===n)}}const Tt="_pagination_ellzc_1",Vt="_button_ellzc_7",_={pagination:Tt,button:Vt};class $t extends h{constructor(){super({tagName:"div",className:_.pagination});i(this,"prevButton");i(this,"nextButton");this.prevButton=new d(_.button,"button","Prev",void 0,!0),this.nextButton=new d(_.button,"button","Next"),this.addChildrenComponents("end",this.prevButton,this.nextButton),this.initListeners()}setButtonStates(t,e){e===0||e===1?(this.prevButton.disable(),this.nextButton.disable()):t===1?(this.prevButton.disable(),this.nextButton.enable()):t===e?(this.prevButton.enable(),this.nextButton.disable()):(this.prevButton.enable(),this.nextButton.enable())}initListeners(){this.nextButton.getElement().addEventListener("click",()=>{this.element.dispatchEvent(new CustomEvent(a.NextPage,{bubbles:!0}))}),this.prevButton.getElement().addEventListener("click",()=>{this.element.dispatchEvent(new CustomEvent(a.PrevPage,{bubbles:!0}))})}}const Nt="_button_1o4jr_1",Mt="_primary_1o4jr_18",Rt="_secondary_1o4jr_35",kt={button:Nt,primary:Mt,secondary:Rt};class qt extends d{constructor(){super(kt.button,"button","Race"),this.initListeners()}initListeners(){this.element.addEventListener("click",()=>{this.element.dispatchEvent(new CustomEvent(a.StartRace,{bubbles:!0}))})}}const jt="_button_49jio_1",Dt="_primary_49jio_18",Qt="_secondary_49jio_35",Wt={button:jt,primary:Dt,secondary:Qt};class Ut extends d{constructor(){super(Wt.button,"button","Stop race",void 0,!0),this.initListeners()}initListeners(){this.element.addEventListener("click",()=>{this.element.dispatchEvent(new CustomEvent(a.StopRace,{bubbles:!0}))})}}const zt="_modal_1i0eu_1",Ht="_fadeIn_1i0eu_1",Xt="_invisible_1i0eu_20",L={modal:zt,fadeIn:Ht,invisible:Xt};class At extends h{constructor(n,t){super({tagName:"div",className:L.modal,textContent:`The ${n.name} car won the race in ${t} sec`}),setTimeout(()=>{this.addClass(L.visible)},0),this.initClickListener()}initClickListener(){this.element.onclick=()=>{this.element.dispatchEvent(new CustomEvent(a.RemoveWinModal,{bubbles:!0}))}}destroy(){this.addClass(L.invisible),this.element.ontransitionend=()=>super.destroy()}}class f extends h{constructor(){super({tagName:"div",className:"page"},new M);i(this,"carsList");i(this,"updateCarFormView");i(this,"raceButton");i(this,"stopRaceButton");i(this,"createCarFormView");i(this,"carQuantityComp");i(this,"currentPage",1);i(this,"pageInfoComp");i(this,"pagination");i(this,"totalPages");i(this,"winModal");this.updateCarFormView=new it,this.raceButton=new qt,this.stopRaceButton=new Ut,this.createCarFormView=new et,this.carQuantityComp=y("",g.carQuantity),this.pageInfoComp=y("",g.pageInfo);const t=R(g.main,k("h1","Garage"),b(g.carForm,this.createCarFormView,this.updateCarFormView,b(g.buttons,this.raceButton,this.stopRaceButton)),this.carQuantityComp,this.pageInfoComp);this.carsList=new Ft(1),this.pagination=new $t,t.addChildrenComponents("end",this.carsList,this.pagination),this.addChildrenComponents("end",t),this.updateCarQuantity(),this.updatePagesInfo(),this.initEventListeners()}async updatePagesInfo(){const t=await f.getPagesQuantity();this.totalPages=t,this.pageInfoComp.setTextContent(`Page #${this.currentPage} / ${t}`),this.pagination.setButtonStates(this.currentPage,this.totalPages)}async updateCarQuantity(){const t=await f.getTotalCarsQuantity();this.carQuantityComp.setTextContent(`Total cars in the Garage: ${t}`)}static async getTotalCarsQuantity(){const t=await E();return t?t.length:0}static async getPagesQuantity(){const t=await f.getTotalCarsQuantity();return Math.ceil(t/C)}initEventListeners(){this.initCreateCarListener(),this.initFocusUpdateCarInputListener(),this.initUpdateCarListener(),this.initDeleteCarListener(),this.initStartRaceListener(),this.initRemoveWinModalListener(),this.initStopRaceListener(),this.initNextPageListener(),this.initPrevPageListener()}initCreateCarListener(){this.element.addEventListener(a.CreateCar,async t=>{if(t instanceof CustomEvent){const{car:e}=t.detail;await q(e),this.carsList.updateChildren(this.currentPage,C),this.createCarFormView.resetInputs(),this.updateCarQuantity(),this.updatePagesInfo()}})}initFocusUpdateCarInputListener(){this.element.addEventListener(a.FocusUpdateCarInput,t=>{if(t instanceof CustomEvent){const{detail:e}=t,{id:s,name:o,color:c}=e.car;this.updateCarFormView.enableForm(),this.updateCarFormView.setCurrentCarId(s);const[u,l]=this.updateCarFormView.inputs;u.focus(),u.setInputValue(o),l.setInputValue(c)}})}initUpdateCarListener(){this.element.addEventListener(a.UpdateCar,async t=>{if(t instanceof CustomEvent){const{car:e}=t.detail,o=await j(e);if(o){const c=this.carsList.findChildComponentById(e.id);c&&c.setCarInfo(o)}this.updateCarFormView.disableForm()}})}initDeleteCarListener(){this.element.addEventListener(a.DeleteCar,async t=>{if(t instanceof CustomEvent){const{car:e}=t.detail,{id:s}=e;await D(s),this.carsList.removeChildComponent(e.id),Q(s)}this.carsList.updateChildren(this.currentPage,C),this.updateCarQuantity(),this.updatePagesInfo()})}initStartRaceListener(){this.element.addEventListener(a.StartRace,async()=>{try{this.raceButton.disable(),this.createCarFormView.disableForm();const t=this.carsList.children.map(m=>m.startCar()),e=await Promise.allSettled(t);this.stopRaceButton.enable();const s=e.map((m,w)=>m.status==="fulfilled"&&m.value?this.carsList.children[w].driveCar(m.value):Promise.reject()),{car:o,engineParams:c}=await Promise.any(s),{id:u}=o,l=Math.round(c.distance/c.velocity/10)/100,v=await W(u);if(v&&v.id){const{id:m,wins:w,time:I}=v,F=w+1;await U(m,F,I>l?l:I)}else await z({id:u,time:l,wins:1});this.winModal=new At(o,l),this.addChildrenComponents("end",this.winModal),setTimeout(()=>{this.winModal&&(this.removeChildComponent(this.winModal),delete this.winModal)},3e3)}catch{console.error("Error occured at the race")}})}initRemoveWinModalListener(){this.element.addEventListener(a.RemoveWinModal,()=>{this.winModal&&(this.removeChildComponent(this.winModal),delete this.winModal)})}initStopRaceListener(){this.element.addEventListener(a.StopRace,async()=>{this.stopRaceButton.disable();const t=this.carsList.children.map(e=>e.stopCar());await Promise.allSettled(t),this.raceButton.enable(),this.createCarFormView.enableForm()})}initNextPageListener(){this.element.addEventListener(a.NextPage,()=>{this.currentPage+=1,this.carsList.updateChildren(this.currentPage,C),this.updatePagesInfo()})}initPrevPageListener(){this.element.addEventListener(a.PrevPage,()=>{this.currentPage-=1,this.carsList.updateChildren(this.currentPage,C),this.updatePagesInfo()})}}export{f as default};
