var N=Object.defineProperty;var $=(r,a,e)=>a in r?N(r,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[a]=e;var s=(r,a,e)=>($(r,typeof a!="symbol"?a+"":a,e),e);import{B as c,S as _,W as x,E as C,a as i,i as L,C as u,b as V,c as A,d as F,e as P,f as q,g as w,h as O}from"./index-BBwHIxAf.js";import{B as I,d as m,p as o,m as W}from"./ButtonView-Cdq7Z-Gm.js";import{I as X}from"./InputView-T_GTZj1F.js";const j="_page_ghghs_1",K="_main_ghghs_8",z="_appName_ghghs_20",y={page:j,main:K,appName:z},G="_header_1kblf_1",J={header:G};class Q extends c{constructor(...a){super({tagName:"header",className:J.header},...a)}}class Y extends I{constructor(){super({type:"button",textContent:"Logout"});s(this,"state",_.getInstance());s(this,"socket",x.getInstance());this.initListeners()}initListeners(){this.element.addEventListener(C.Click,()=>{const e=this.state.getValue(i.CurrentUser);console.log(this.state),e&&L(e)&&this.socket.sendLogoutRequest(e.login,e.password)})}}const Z="_list_twoah_1",ee="_user_twoah_10",te="_online_twoah_32",se="_offline_twoah_35",ie="_hidden_twoah_39",h={list:Z,user:ee,online:te,offline:se,hidden:ie};class ne extends c{constructor(){super({tagName:"div",className:h.list});s(this,"socket",x.getInstance());s(this,"state",_.getInstance());s(this,"activeUsersContainer");s(this,"inactiveUsersContainer");s(this,"searchInput");s(this,"updateActiveUsersList",()=>{const e=this.state.getValue(i.ActiveUsers),t=this.state.getValue(i.CurrentUser),n=L(t)?t.login:null;if(V(e)){const d=e.reduce((g,p)=>(p.login!==n&&g.push(o(p.login,`${h.user} ${h.online}`)),g),[]);this.activeUsersContainer.removeChildrenComponents(),this.activeUsersContainer.addChildrenComponents("end",...d)}});s(this,"updateInActiveUsersList",()=>{const e=this.state.getValue(i.InactiveUsers);if(V(e)){const t=e.map(n=>o(n.login,`${h.user} ${h.offline}`));this.inactiveUsersContainer.removeChildrenComponents(),this.inactiveUsersContainer.addChildrenComponents("end",...t)}});s(this,"handleExternalLogin",()=>{const e=this.state.getValue(i.ExternalLogin);typeof e=="string"&&(this.inactiveUsersContainer.removeChildComponent(e),this.activeUsersContainer.addChildrenComponents("begin",o(e,`${h.user} ${h.online}`)))});s(this,"handleExternalLogout",()=>{const e=this.state.getValue(i.ExternalLogout);typeof e=="string"&&(this.activeUsersContainer.removeChildComponent(e),this.inactiveUsersContainer.addChildrenComponents("begin",o(e,`${h.user} ${h.offline}`)))});this.searchInput=new X({type:"search"}),this.activeUsersContainer=m(),this.inactiveUsersContainer=m(),this.addChildrenComponents("end",this.searchInput,this.activeUsersContainer,this.inactiveUsersContainer),this.socket.sendActiveUsersRequest(),this.socket.sendInActiveUsersRequest(),this.state.subscribe(i.ActiveUsers,this.updateActiveUsersList),this.state.subscribe(i.InactiveUsers,this.updateInActiveUsersList),this.state.subscribe(i.ExternalLogin,this.handleExternalLogin),this.state.subscribe(i.ExternalLogout,this.handleExternalLogout),this.initEventListeners()}initEventListeners(){this.initClickListener(),this.initSearchInputListener()}initClickListener(){this.element.addEventListener("click",({target:e})=>{e instanceof HTMLParagraphElement&&e.dispatchEvent(new CustomEvent(u.OpenChat,{bubbles:!0,detail:e.textContent}))})}initSearchInputListener(){this.element.addEventListener(u.FormInput,e=>{if(e instanceof CustomEvent){const t=e.detail;typeof t=="string"&&(this.activeUsersContainer.children.forEach(n=>{var d;(d=n.getTextContent())!=null&&d.startsWith(t)?n.removeClass(h.hidden):n.addClass(h.hidden)}),this.inactiveUsersContainer.children.forEach(n=>{var d;(d=n.getTextContent())!=null&&d.startsWith(t)?n.removeClass(h.hidden):n.addClass(h.hidden)}))}})}}const ae="_chatHeader_1meae_1",oe="_chat_1meae_1",re="_disclaimer_1meae_18",U={chatHeader:ae,chat:oe,disclaimer:re},de="_message_13bl4_1",he="_outgoing_13bl4_13",le="_incoming_13bl4_16",ce="_topInfo_13bl4_24",ue="_actionButtons_13bl4_34",ge="_bottomInfo_13bl4_47",me="_fromUser_13bl4_57",Ce="_statusContainer_13bl4_63",pe="_readStatus_13bl4_67",l={message:de,outgoing:he,incoming:le,topInfo:ce,actionButtons:ue,bottomInfo:ge,fromUser:me,statusContainer:Ce,readStatus:pe};class M extends c{constructor(e,t){const{from:n,to:d,id:g,datetime:p,status:S}=e,{isReaded:f,isDelivered:b,isEdited:E}=S;super({tagName:"div",className:`${l.message} ${t}`});s(this,"to");s(this,"isReaded");s(this,"isDelivered");s(this,"isEdited");s(this,"id");s(this,"socket",x.getInstance());s(this,"datetime");s(this,"state",_.getInstance());s(this,"textComp");s(this,"editedStatusComp");s(this,"deliveredStatusComp");s(this,"readStatusComp");s(this,"deleteButton");s(this,"editButton");s(this,"deliveredReadStatusComp");s(this,"from");s(this,"changeDeliveredStatus",()=>{var t;const e=this.state.getValue(i.MessageDelivered);A(e)&&e.message.id===this.id&&e.message.status.isDelivered===!0&&((t=this.deliveredStatusComp)==null||t.setTextContent("ðŸ—¸"),this.isDelivered=!0,this.state.unsubscribe(i.MessageDelivered,this.changeDeliveredStatus))});s(this,"changeReadStatus",()=>{var t;const e=this.state.getValue(i.MessageRead);F(e)&&e.message.id===this.id&&e.message.status.isReaded===!0&&((t=this.readStatusComp)==null||t.setTextContent("ðŸ—¸"),this.isReaded=!0,this.state.unsubscribe(i.MessageRead,this.changeReadStatus))});s(this,"editMessage",()=>{var t,n;const e=this.state.getValue(i.MessageEdited);P(e)&&e.message.id===this.id&&e.message.status.isEdited===!0&&(this.isEdited=!0,(t=this.editedStatusComp)==null||t.setTextContent("edited"),(n=this.textComp)==null||n.setTextContent(e.message.text))});this.from=n,this.to=d,this.id=g,this.datetime=p,this.isReaded=f,this.isDelivered=b,this.isEdited=E,this.renderMessageInfo(e),b||this.state.subscribe(i.MessageDelivered,this.changeDeliveredStatus),f||this.state.subscribe(i.MessageRead,this.changeReadStatus),this.state.subscribe(i.MessageEdited,this.editMessage),this.initListeners()}destroy(){super.destroy(),this.state.unsubscribe(i.MessageDelivered,this.changeDeliveredStatus),this.state.unsubscribe(i.MessageRead,this.changeReadStatus),this.state.unsubscribe(i.MessageEdited,this.editMessage)}initListeners(){this.initDeleteListener(),this.initEditListener()}initDeleteListener(){this.deleteButton&&this.deleteButton.getElement().addEventListener(C.Click,()=>{this.socket.sendDeleleMessageRequest(this.id)})}initEditListener(){this.editButton&&this.editButton.getElement().addEventListener(C.Click,()=>{var e,t;(t=this.editButton)==null||t.getElement().dispatchEvent(new CustomEvent(u.EditMessage,{bubbles:!0,detail:{text:(e=this.textComp)==null?void 0:e.getTextContent(),id:this.id}}))})}renderMessageInfo(e){const{text:t,from:n,status:d}=e,{isDelivered:g,isEdited:p,isReaded:S}=d;this.textComp=o(t);const f=[],b=[];let E=n;this.isMesageFromCurrentUser()&&(E="you",this.deleteButton=o("âœ–"),this.editButton=o("âœŽ"),f.push(m(l.actionButtons,this.editButton,this.deleteButton)),this.deliveredStatusComp=o(g?"ðŸ—¸":"â—”",l.deliveredStatus),this.readStatusComp=o(g&&S?"ðŸ—¸":"",l.readStatus),this.deliveredReadStatusComp=m(l.statusContainer,this.deliveredStatusComp,this.readStatusComp),b.push(this.deliveredReadStatusComp)),f.unshift(o(E,l.fromUser));const D=o(this.formatDateTime());b.unshift(this.editedStatusComp=o(p?"edited":""),D),this.addChildrenComponents("end",m(l.topInfo,...f),this.textComp,m(l.bottomInfo,...b))}isMesageFromCurrentUser(){const e=this.state.getValue(i.CurrentUser);return!!(L(e)&&e.login===this.from)}formatDateTime(){const e=new Date(this.datetime),t=e.getHours(),n=e.getMinutes(),d=`${t<10?`0${t}`:t}`,g=`${n<10?`0${n}`:n}`;return`${d}:${g}`}}const fe="_form_1pt2h_1",be="_edit_1pt2h_9",T={form:fe,edit:be},ve="_textarea_eabgv_1",_e={textarea:ve};class Me extends c{constructor(a){super({tagName:"textarea",className:_e.textarea,...a}),this.initListeners()}getValue(){return this.element.value}setValue(a){this.element.value=a}focus(){this.element.focus()}disable(){this.element.disabled=!0}enable(){this.element.disabled=!1}setParameters(a){super.setParameters(a);const{required:e,disabled:t}=a;e&&(this.element.required=e),t&&(this.element.disabled=t)}initListeners(){this.element.addEventListener(C.Input,()=>{this.element.dispatchEvent(new CustomEvent(u.FormInput,{bubbles:!0,detail:this.getValue()}))}),this.element.addEventListener(C.Change,()=>{this.element.dispatchEvent(new CustomEvent(u.FormChange,{bubbles:!0,detail:this.getValue()}))})}}class xe extends c{constructor(){super({tagName:"form",className:T.form,novalidate:!0});s(this,"editingMessage",null);s(this,"messageTextArea");s(this,"sendButton");s(this,"defineButtonState",()=>{console.log("event"),this.messageTextArea.getValue().length===0?this.sendButton.disable():this.sendButton.enable()});this.messageTextArea=new Me({disabled:!0}),this.sendButton=new I({type:"submit",textContent:"Send",disabled:!0}),this.addChildrenComponents("end",this.messageTextArea,this.sendButton),this.initListeners()}enable(){this.messageTextArea.enable()}disable(){this.messageTextArea.disable(),this.sendButton.disable()}clear(){this.messageTextArea.setValue("")}enableEditMode(e,t){this.messageTextArea.focus(),this.messageTextArea.setValue(t),this.editingMessage={id:e,text:t},this.defineButtonState(),this.sendButton.addClass(T.edit),this.sendButton.setTextContent("Edit")}disableEditMode(){this.messageTextArea.setValue(""),this.editingMessage=null,this.defineButtonState(),this.sendButton.removeClass(T.edit),this.sendButton.setTextContent("Send")}setParameters(e){super.setParameters(e);const{novalidate:t}=e;t&&(this.element.noValidate=t)}initListeners(){this.initSubmitListener(),this.initFormInputListener()}initSubmitListener(){this.element.addEventListener(C.Submit,e=>{e.preventDefault();const t=this.messageTextArea.getValue();this.element.dispatchEvent(new CustomEvent(u.SendChatMessage,{bubbles:!0,detail:t}))})}initFormInputListener(){this.element.addEventListener(u.FormInput,this.defineButtonState)}}const Le="_messageHistory_155me_1",Ee="_plugText_155me_13",B={messageHistory:Le,plugText:Ee};class Se extends c{constructor(e){super({tagName:"div",className:`${B.messageHistory}`});s(this,"plugText");s(this,"socket",x.getInstance());s(this,"state",_.getInstance());s(this,"username");s(this,"readMessages",()=>{const e=this.state.getValue(i.CurrentUser);let t;L(e)&&({login:t}=e),this.children.forEach(n=>{n instanceof M&&!n.isReaded&&t===n.to&&this.socket.sendReadMessageRequest(n.id)})});s(this,"deleteMessage",()=>{const e=this.state.getValue(i.MessageDeleted);if(q(e)&&e.message.status.isDeleted===!0){const{id:t}=e.message,n=this.children.find(d=>d.id===t);n&&(this.removeChildComponent(n),this.children.length===0&&this.setPlugText(this.username))}});e&&(this.username=e),this.initListeners(),this.state.subscribe(i.MessageDeleted,this.deleteMessage),this.element.scrollTop=this.element.scrollHeight}setPlugText(e){this.plugText=o(`This is the very beginning of your conversation with ${e||"user"}.`,B.plugText),this.addChildrenComponents("end",this.plugText)}destroy(){super.destroy(),this.state.unsubscribe(i.MessageDeleted,this.deleteMessage)}removePlugText(){this.plugText&&this.removeChildComponent(this.plugText)}initListeners(){this.initScrollListener(),this.initClickListener()}initScrollListener(){this.element.addEventListener(C.Scroll,this.readMessages)}initClickListener(){this.element.addEventListener(C.Click,this.readMessages)}}class R extends c{constructor(e){super({tagName:"div",className:U.chat});s(this,"socket",x.getInstance());s(this,"state",_.getInstance());s(this,"messageHistory");s(this,"messageForm");s(this,"username");s(this,"showSentMessage",()=>{const e=this.state.getValue(i.MessageSent);if(w(e)){const{to:t}=e;t===this.username&&(this.messageHistory.removePlugText(),this.messageHistory.addChildrenComponents("end",new M(e,l.outgoing)))}this.messageForm.clear()});s(this,"showReceivedMessage",()=>{const e=this.state.getValue(i.MessageReceived);if(console.log("adding received message",w(e)),w(e)){const{from:t}=e;t===this.username&&(this.messageHistory.removePlugText(),this.messageHistory.addChildrenComponents("end",new M(e,l.incoming)))}});s(this,"showMessageHistory",()=>{const e=this.state.getValue(i.MessageHistory);O(e)&&(e.length&&(e[0].from===this.username||e[0].to===this.username)?e.forEach(t=>{t.from===this.username?this.messageHistory.addChildrenComponents("end",new M(t,l.incoming)):this.messageHistory.addChildrenComponents("end",new M(t,l.outgoing))}):this.messageHistory.setPlugText(this.username))});this.messageHistory=new Se(e),this.messageForm=new xe,this.addChildrenComponents("end",this.messageHistory,m("",this.messageForm)),e?(this.username=e,this.addChildrenComponents("begin",o(e,U.chatHeader)),this.state.subscribe(i.MessageSent,this.showSentMessage),this.state.subscribe(i.MessageReceived,this.showReceivedMessage),this.state.subscribe(i.MessageHistory,this.showMessageHistory),this.messageForm.enable(),this.socket.sendMessageHistoryRequest(e)):this.messageHistory.addChildrenComponents("end",o("Select a chat to start messaging.",U.disclaimer)),this.initListeners()}destroy(){super.destroy(),this.state.unsubscribe(i.MessageSent,this.showSentMessage),this.state.unsubscribe(i.MessageReceived,this.showReceivedMessage),this.state.unsubscribe(i.MessageHistory,this.showMessageHistory)}initListeners(){this.initSendMessageListener(),this.editMessageListener()}initSendMessageListener(){this.element.addEventListener(u.SendChatMessage,e=>{if(e instanceof CustomEvent){const t=e.detail;if(this.username&&typeof t=="string")if(this.messageForm.editingMessage){const{id:n}=this.messageForm.editingMessage;this.socket.sendEditMessageRequest(n,t),this.messageForm.disableEditMode()}else this.socket.sendChatMessage(this.username,t);this.messageForm.defineButtonState(),this.messageHistory.readMessages()}})}editMessageListener(){this.element.addEventListener(u.EditMessage,e=>{if(e instanceof CustomEvent){const t=e.detail;if(t instanceof Object&&typeof t.text=="string"&&typeof t.id=="string"){const{text:n,id:d}=t;console.log("need to edit message",n),this.messageForm.enableEditMode(d,n)}}})}}const we="_anchor_1ldv3_1",ye={anchor:we};class k extends c{constructor(a,e){super({tagName:"a",className:ye.anchor,href:a}),typeof e=="string"?this.setTextContent(e):this.addChildrenComponents("end",e)}setParameters(a){super.setParameters(a);const{href:e}=a;e&&(this.element.href=e)}}class H extends c{constructor(a,e="",t){super({tagName:"img",className:t,src:a,alt:e})}setParameters(a){super.setParameters(a);const{alt:e,src:t}=a;t&&(this.element.src=t),e?this.element.alt=e:this.element.alt=""}}const Ue="_footer_12a1k_1",Te="_link_12a1k_12",Ie="_logo_12a1k_18",Ve="_aboutButton_12a1k_22",v={footer:Ue,link:Te,logo:Ie,aboutButton:Ve},Be=""+new URL("github-logo-DkTr3Tul.png",import.meta.url).href,Re=""+new URL("rs-logo-2XN05XgC.webp",import.meta.url).href;class ke extends c{constructor(){super({tagName:"footer",className:v.footer},new k("https://rs.school/",m(v.link,new H(Re,"rs-school logo",v.logo),o("RS School "))),o("2024"),new I({type:"button",textContent:"About the app",className:v.aboutButton},"about"),new k("https://github.com/dementeyolga",m(v.link,new H(Be,"github logo",v.logo),o("Olga Dementey"))))}}class Ae extends c{constructor(){super({tagName:"div",className:y.page});s(this,"state",_.getInstance());s(this,"chat");s(this,"main");const e=[o("Fun Chat",y.appName),new Y],t=this.state.getValue(i.CurrentUser);L(t)&&e.unshift(o(t.login)),this.chat=new R,this.main=W(y.main,new ne,this.chat),this.addChildrenComponents("end",new Q(...e),this.main,new ke),this.initListeners()}initListeners(){this.initOpenChatListener()}initOpenChatListener(){this.element.addEventListener(u.OpenChat,e=>{if(e instanceof CustomEvent){const t=e.detail;typeof t=="string"&&(this.main.removeChildComponent(this.chat),this.chat=new R(t),this.main.addChildrenComponents("end",this.chat))}})}}export{Ae as default};
