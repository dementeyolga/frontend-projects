var F=Object.defineProperty;var P=(o,a,e)=>a in o?F(o,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[a]=e;var s=(o,a,e)=>(P(o,typeof a!="symbol"?a+"":a,e),e);import{B as u,a as R,S as p,W as x,E as C,b as n,i as y,p as r,c as A,d as S,e as m,C as c,g as O,f as H,h as q,j as G,k as K,l as j,m as W}from"./index-CHDHNAJZ.js";import{I as X}from"./InputView-SSld5dbV.js";const z="_page_ghghs_1",Q="_main_ghghs_8",J="_appName_ghghs_20",U={page:z,main:Q,appName:J},Y="_header_1kblf_1",Z={header:Y};class ee extends u{constructor(...a){super({tagName:"header",className:Z.header},...a)}}class te extends R{constructor(){super({type:"button",textContent:"Logout"});s(this,"state",p.getInstance());s(this,"socket",x.getInstance());this.initListeners()}initListeners(){this.element.addEventListener(C.Click,()=>{const e=this.state.getValue(n.CurrentUser);console.log(this.state),e&&y(e)&&this.socket.sendLogoutRequest(e.login,e.password)})}}const se="_counter_cbki9_1",ie="_invisible_cbki9_14",E={counter:se,invisible:ie};class M extends u{constructor(e,t){super({tagName:"p",className:t,textContent:e});s(this,"unreadMessageCounter");s(this,"state",p.getInstance());s(this,"socket",x.getInstance());s(this,"username");s(this,"handleMessageHistory",()=>{const e=this.state.getValue(n.MessageHistory);if(A(e)&&e.length&&e[0].from===this.username){const t=e.filter(i=>i.status.isReaded===!1&&i.from===this.username).length;this.unreadMessageCounter.setTextContent(String(t)),t&&this.unreadMessageCounter.removeClass(E.invisible)}});s(this,"incrementUnreadMessages",()=>{const e=this.state.getValue(n.MessageReceived);if(S(e)){const{from:t}=e;if(t===this.username){console.log("need to increment unred");const i=this.unreadMessageCounter.getTextContent(),d=i?parseInt(i,10):0;Number.isFinite(d)&&(this.unreadMessageCounter.setTextContent(String(d+1)),this.unreadMessageCounter.removeClass(E.invisible))}}});s(this,"resetUnreadMessages",()=>{typeof this.state.getValue(n.ResetUnreadMessages)=="string"&&(this.unreadMessageCounter.setTextContent(""),this.unreadMessageCounter.addClass(E.invisible))});this.username=e,this.unreadMessageCounter=r("",`${E.counter} ${E.invisible}`),this.addChildrenComponents("end",this.unreadMessageCounter),this.state.subscribe(n.MessageHistory,this.handleMessageHistory),this.state.subscribe(n.MessageReceived,this.incrementUnreadMessages),this.state.subscribe(n.ResetUnreadMessages,this.resetUnreadMessages),this.socket.sendMessageHistoryRequest(this.username)}destroy(){super.destroy(),this.state.unsubscribe(n.MessageHistory,this.handleMessageHistory),this.state.unsubscribe(n.MessageReceived,this.incrementUnreadMessages),this.state.unsubscribe(n.ResetUnreadMessages,this.resetUnreadMessages)}}const ne="_list_1tcrb_1",ae="_user_1tcrb_10",oe="_online_1tcrb_34",re="_offline_1tcrb_37",de="_hidden_1tcrb_41",h={list:ne,user:ae,online:oe,offline:re,hidden:de};class he extends u{constructor(){super({tagName:"div",className:h.list});s(this,"socket",x.getInstance());s(this,"state",p.getInstance());s(this,"activeUsersContainer");s(this,"inactiveUsersContainer");s(this,"searchInput");s(this,"updateActiveUsersList",()=>{const e=this.state.getValue(n.ActiveUsers),t=this.state.getValue(n.CurrentUser),i=y(t)?t.login:null;if(H(e)){const d=e.reduce((g,f)=>(f.login!==i&&g.push(new M(f.login,`${h.user} ${h.online}`)),g),[]);this.activeUsersContainer.removeChildrenComponents(),this.activeUsersContainer.addChildrenComponents("end",...d)}});s(this,"updateInActiveUsersList",()=>{const e=this.state.getValue(n.InactiveUsers);if(H(e)){const t=e.map(i=>new M(i.login,`${h.user} ${h.offline}`));this.inactiveUsersContainer.removeChildrenComponents(),this.inactiveUsersContainer.addChildrenComponents("end",...t)}});s(this,"handleExternalLogin",()=>{const e=this.state.getValue(n.ExternalLogin);typeof e=="string"&&!this.activeUsersContainer.findChildComponentByTextContent(e)&&(console.log("EXTERNAL LOGIN REMOVING FROM INACTIVE ADDING TO ACTIVE",e),this.inactiveUsersContainer.removeChildComponent(e),this.activeUsersContainer.addChildrenComponents("begin",new M(e,`${h.user} ${h.online}`)))});s(this,"handleExternalLogout",()=>{const e=this.state.getValue(n.ExternalLogout);typeof e=="string"&&!this.inactiveUsersContainer.findChildComponentByTextContent(e)&&(console.log("EXTERNAL LOGIN REMOVING FROM ACTIVE ADDING TO INACTIVE",e),this.activeUsersContainer.removeChildComponent(e),this.inactiveUsersContainer.addChildrenComponents("begin",new M(e,`${h.user} ${h.offline}`)))});this.searchInput=new X({type:"search"}),this.activeUsersContainer=m(),this.inactiveUsersContainer=m(),this.addChildrenComponents("end",this.searchInput,this.activeUsersContainer,this.inactiveUsersContainer),this.socket.sendActiveUsersRequest(),this.socket.sendInActiveUsersRequest(),this.state.subscribe(n.ActiveUsers,this.updateActiveUsersList),this.state.subscribe(n.InactiveUsers,this.updateInActiveUsersList),this.state.subscribe(n.ExternalLogin,this.handleExternalLogin),this.state.subscribe(n.ExternalLogout,this.handleExternalLogout),this.initEventListeners()}initEventListeners(){this.initClickListener(),this.initSearchInputListener()}initClickListener(){this.element.addEventListener("click",({target:e})=>{e instanceof HTMLParagraphElement&&e.dispatchEvent(new CustomEvent(c.OpenChat,{bubbles:!0,detail:O(e)}))})}initSearchInputListener(){this.element.addEventListener(c.FormInput,e=>{if(e instanceof CustomEvent){const t=e.detail;typeof t=="string"&&(this.activeUsersContainer.children.forEach(i=>{i instanceof M&&i.username.startsWith(t)?i.removeClass(h.hidden):i.addClass(h.hidden)}),this.inactiveUsersContainer.children.forEach(i=>{i instanceof M&&i.username.startsWith(t)?i.removeClass(h.hidden):i.addClass(h.hidden)}))}})}}const le="_chatHeader_1meae_1",ue="_chat_1meae_1",ce="_disclaimer_1meae_18",T={chatHeader:le,chat:ue,disclaimer:ce},ge="_message_13bl4_1",me="_outgoing_13bl4_13",Ce="_incoming_13bl4_16",fe="_topInfo_13bl4_24",pe="_actionButtons_13bl4_34",be="_bottomInfo_13bl4_47",ve="_fromUser_13bl4_57",Me="_statusContainer_13bl4_63",_e="_readStatus_13bl4_67",l={message:ge,outgoing:me,incoming:Ce,topInfo:fe,actionButtons:pe,bottomInfo:be,fromUser:ve,statusContainer:Me,readStatus:_e};class L extends u{constructor(e,t){const{from:i,to:d,id:g,datetime:f,status:I}=e,{isReaded:b,isDelivered:v,isEdited:w}=I;super({tagName:"div",className:`${l.message} ${t}`});s(this,"to");s(this,"isReaded");s(this,"isDelivered");s(this,"isEdited");s(this,"id");s(this,"socket",x.getInstance());s(this,"datetime");s(this,"state",p.getInstance());s(this,"textComp");s(this,"editedStatusComp");s(this,"deliveredStatusComp");s(this,"readStatusComp");s(this,"deleteButton");s(this,"editButton");s(this,"deliveredReadStatusComp");s(this,"from");s(this,"changeDeliveredStatus",()=>{var t;const e=this.state.getValue(n.MessageDelivered);q(e)&&e.message.id===this.id&&e.message.status.isDelivered===!0&&((t=this.deliveredStatusComp)==null||t.setTextContent("ðŸ—¸"),this.isDelivered=!0,this.state.unsubscribe(n.MessageDelivered,this.changeDeliveredStatus))});s(this,"changeReadStatus",()=>{var t;const e=this.state.getValue(n.MessageRead);G(e)&&e.message.id===this.id&&e.message.status.isReaded===!0&&((t=this.readStatusComp)==null||t.setTextContent("ðŸ—¸"),this.isReaded=!0,this.state.unsubscribe(n.MessageRead,this.changeReadStatus),this.isMesageFromCurrentUser()||this.state.setValue(n.ResetUnreadMessages,this.from))});s(this,"editMessage",()=>{var t,i;const e=this.state.getValue(n.MessageEdited);K(e)&&e.message.id===this.id&&e.message.status.isEdited===!0&&(this.isEdited=!0,(t=this.editedStatusComp)==null||t.setTextContent("edited"),(i=this.textComp)==null||i.setTextContent(e.message.text))});this.from=i,this.to=d,this.id=g,this.datetime=f,this.isReaded=b,this.isDelivered=v,this.isEdited=w,this.renderMessageInfo(e),v||this.state.subscribe(n.MessageDelivered,this.changeDeliveredStatus),b||this.state.subscribe(n.MessageRead,this.changeReadStatus),this.state.subscribe(n.MessageEdited,this.editMessage),this.initListeners()}destroy(){super.destroy(),this.state.unsubscribe(n.MessageDelivered,this.changeDeliveredStatus),this.state.unsubscribe(n.MessageRead,this.changeReadStatus),this.state.unsubscribe(n.MessageEdited,this.editMessage)}initListeners(){this.initDeleteListener(),this.initEditListener()}initDeleteListener(){this.deleteButton&&this.deleteButton.getElement().addEventListener(C.Click,()=>{this.socket.sendDeleleMessageRequest(this.id)})}initEditListener(){this.editButton&&this.editButton.getElement().addEventListener(C.Click,()=>{var e,t;(t=this.editButton)==null||t.getElement().dispatchEvent(new CustomEvent(c.EditMessage,{bubbles:!0,detail:{text:(e=this.textComp)==null?void 0:e.getTextContent(),id:this.id}}))})}renderMessageInfo(e){const{text:t,from:i,status:d}=e,{isDelivered:g,isEdited:f,isReaded:I}=d;this.textComp=r(t);const b=[],v=[];let w=i;this.isMesageFromCurrentUser()&&(w="you",this.deleteButton=r("âœ–"),this.editButton=r("âœŽ"),b.push(m(l.actionButtons,this.editButton,this.deleteButton)),this.deliveredStatusComp=r(g?"ðŸ—¸":"â—”",l.deliveredStatus),this.readStatusComp=r(g&&I?"ðŸ—¸":"",l.readStatus),this.deliveredReadStatusComp=m(l.statusContainer,this.deliveredStatusComp,this.readStatusComp),v.push(this.deliveredReadStatusComp)),b.unshift(r(w,l.fromUser));const $=r(this.formatDateTime());v.unshift(this.editedStatusComp=r(f?"edited":""),$),this.addChildrenComponents("end",m(l.topInfo,...b),this.textComp,m(l.bottomInfo,...v))}isMesageFromCurrentUser(){const e=this.state.getValue(n.CurrentUser);return!!(y(e)&&e.login===this.from)}formatDateTime(){const e=new Date(this.datetime),t=e.getHours(),i=e.getMinutes(),d=`${t<10?`0${t}`:t}`,g=`${i<10?`0${i}`:i}`;return`${d}:${g}`}}const xe="_form_kz6sj_1",Ee="_edit_kz6sj_10",V={form:xe,edit:Ee},Le="_textarea_eabgv_1",ye={textarea:Le};class we extends u{constructor(a){super({tagName:"textarea",className:ye.textarea,...a}),this.initListeners()}getValue(){return this.element.value}setValue(a){this.element.value=a}focus(){this.element.focus()}disable(){this.element.disabled=!0}enable(){this.element.disabled=!1}setParameters(a){super.setParameters(a);const{required:e,disabled:t}=a;e&&(this.element.required=e),t&&(this.element.disabled=t)}initListeners(){this.element.addEventListener(C.Input,()=>{this.element.dispatchEvent(new CustomEvent(c.FormInput,{bubbles:!0,detail:this.getValue()}))}),this.element.addEventListener(C.Change,()=>{this.element.dispatchEvent(new CustomEvent(c.FormChange,{bubbles:!0,detail:this.getValue()}))})}}class Se extends u{constructor(){super({tagName:"form",className:V.form,novalidate:!0});s(this,"editingMessage",null);s(this,"messageTextArea");s(this,"sendButton");s(this,"defineButtonState",()=>{console.log("event"),this.messageTextArea.getValue().length===0?this.sendButton.disable():this.sendButton.enable()});this.messageTextArea=new we({disabled:!0}),this.sendButton=new R({type:"submit",textContent:"Send",disabled:!0}),this.addChildrenComponents("end",this.messageTextArea,this.sendButton),this.initListeners()}enable(){this.messageTextArea.enable()}disable(){this.messageTextArea.disable(),this.sendButton.disable()}clear(){this.messageTextArea.setValue("")}focus(){this.messageTextArea.focus()}enableEditMode(e,t){this.messageTextArea.focus(),this.messageTextArea.setValue(t),this.editingMessage={id:e,text:t},this.defineButtonState(),this.sendButton.addClass(V.edit),this.sendButton.setTextContent("Edit")}disableEditMode(){this.messageTextArea.setValue(""),this.editingMessage=null,this.defineButtonState(),this.sendButton.removeClass(V.edit),this.sendButton.setTextContent("Send")}setParameters(e){super.setParameters(e);const{novalidate:t}=e;t&&(this.element.noValidate=t)}initListeners(){this.initSubmitListener(),this.initFormInputListener(),this.initKeyPressListener()}initSubmitListener(){this.element.addEventListener(C.Submit,e=>{e.preventDefault();const t=this.messageTextArea.getValue();this.element.dispatchEvent(new CustomEvent(c.SendChatMessage,{bubbles:!0,detail:t}))})}initFormInputListener(){this.element.addEventListener(c.FormInput,this.defineButtonState)}initKeyPressListener(){this.element.addEventListener(C.Keydown,e=>{if(e.code==="Enter"&&!e.shiftKey){e.preventDefault();const t=this.messageTextArea.getValue();this.element.dispatchEvent(new CustomEvent(c.SendChatMessage,{bubbles:!0,detail:t}))}})}}const Ie="_messageHistory_155me_1",Ue="_plugText_155me_13",k={messageHistory:Ie,plugText:Ue};class Te extends u{constructor(e){super({tagName:"div",className:`${k.messageHistory}`});s(this,"plugText");s(this,"socket",x.getInstance());s(this,"state",p.getInstance());s(this,"username");s(this,"readMessages",()=>{const e=this.state.getValue(n.CurrentUser);let t;y(e)&&({login:t}=e),this.children.forEach(i=>{i instanceof L&&!i.isReaded&&t===i.to&&this.socket.sendReadMessageRequest(i.id)})});s(this,"deleteMessage",()=>{const e=this.state.getValue(n.MessageDeleted);if(j(e)&&e.message.status.isDeleted===!0){const{id:t}=e.message,i=this.children.find(d=>d.id===t);i&&(this.removeChildComponent(i),this.children.length===0&&this.setPlugText(this.username))}});e&&(this.username=e),this.initListeners(),this.state.subscribe(n.MessageDeleted,this.deleteMessage),this.element.scrollTop=this.element.scrollHeight}setPlugText(e){this.plugText=r(`This is the very beginning of your conversation with ${e||"user"}.`,k.plugText),this.addChildrenComponents("end",this.plugText)}destroy(){super.destroy(),this.state.unsubscribe(n.MessageDeleted,this.deleteMessage)}removePlugText(){this.plugText&&this.removeChildComponent(this.plugText)}initListeners(){this.initScrollListener(),this.initClickListener()}initScrollListener(){this.element.addEventListener(C.Scroll,this.readMessages)}initClickListener(){this.element.addEventListener(C.Click,this.readMessages)}}class B extends u{constructor(e){super({tagName:"div",className:T.chat});s(this,"socket",x.getInstance());s(this,"state",p.getInstance());s(this,"messageHistory");s(this,"messageForm");s(this,"username");s(this,"showSentMessage",()=>{const e=this.state.getValue(n.MessageSent);if(S(e)){const{to:t}=e;if(t===this.username){this.messageHistory.removePlugText();const i=new L(e,l.outgoing);this.messageHistory.addChildrenComponents("end",i),i.getElement().scrollIntoView()}}this.messageForm.clear()});s(this,"showReceivedMessage",()=>{const e=this.state.getValue(n.MessageReceived);if(console.log("adding received message",S(e)),S(e)){const{from:t}=e;if(t===this.username){this.messageHistory.removePlugText();const i=new L(e,l.incoming);this.messageHistory.addChildrenComponents("end",i),i.getElement().scrollIntoView()}}});s(this,"showMessageHistory",()=>{const e=this.state.getValue(n.MessageHistory);A(e)&&(e.length&&(e[0].from===this.username||e[0].to===this.username)?(e.forEach(t=>{t.from===this.username?this.messageHistory.addChildrenComponents("end",new L(t,l.incoming)):this.messageHistory.addChildrenComponents("end",new L(t,l.outgoing))}),this.messageHistory.children[this.messageHistory.children.length-1].getElement().scrollIntoView()):this.messageHistory.setPlugText(this.username))});this.messageHistory=new Te(e),this.messageForm=new Se,this.addChildrenComponents("end",this.messageHistory,m("",this.messageForm)),e?(this.username=e,this.addChildrenComponents("begin",r(e,T.chatHeader)),this.state.subscribe(n.MessageSent,this.showSentMessage),this.state.subscribe(n.MessageReceived,this.showReceivedMessage),this.state.subscribe(n.MessageHistory,this.showMessageHistory),this.messageForm.enable(),this.socket.sendMessageHistoryRequest(e)):this.messageHistory.addChildrenComponents("end",r("Select a chat to start messaging.",T.disclaimer)),this.initListeners()}destroy(){super.destroy(),this.state.unsubscribe(n.MessageSent,this.showSentMessage),this.state.unsubscribe(n.MessageReceived,this.showReceivedMessage),this.state.unsubscribe(n.MessageHistory,this.showMessageHistory)}initListeners(){this.initSendMessageListener(),this.editMessageListener()}initSendMessageListener(){this.element.addEventListener(c.SendChatMessage,e=>{if(e instanceof CustomEvent){const t=e.detail;if(this.username&&typeof t=="string")if(this.messageForm.editingMessage){const{id:i}=this.messageForm.editingMessage;this.socket.sendEditMessageRequest(i,t),this.messageForm.disableEditMode()}else this.socket.sendChatMessage(this.username,t);this.messageForm.defineButtonState(),this.messageForm.focus(),this.messageHistory.readMessages()}})}editMessageListener(){this.element.addEventListener(c.EditMessage,e=>{if(e instanceof CustomEvent){const t=e.detail;if(t instanceof Object&&typeof t.text=="string"&&typeof t.id=="string"){const{text:i,id:d}=t;console.log("need to edit message",i),this.messageForm.enableEditMode(d,i)}}})}}const Ve="_anchor_1ldv3_1",Re={anchor:Ve};class N extends u{constructor(a,e){super({tagName:"a",className:Re.anchor,href:a}),typeof e=="string"?this.setTextContent(e):this.addChildrenComponents("end",e)}setParameters(a){super.setParameters(a);const{href:e}=a;e&&(this.element.href=e)}}class D extends u{constructor(a,e="",t){super({tagName:"img",className:t,src:a,alt:e})}setParameters(a){super.setParameters(a);const{alt:e,src:t}=a;t&&(this.element.src=t),e?this.element.alt=e:this.element.alt=""}}const He="_footer_12a1k_1",ke="_link_12a1k_12",Be="_logo_12a1k_18",Ne="_aboutButton_12a1k_22",_={footer:He,link:ke,logo:Be,aboutButton:Ne},De=""+new URL("github-logo-DkTr3Tul.png",import.meta.url).href,Ae=""+new URL("rs-logo-2XN05XgC.webp",import.meta.url).href;class $e extends u{constructor(){super({tagName:"footer",className:_.footer},new N("https://rs.school/",m(_.link,new D(Ae,"rs-school logo",_.logo),r("RS School "))),r("2024"),new R({type:"button",textContent:"About the app",className:_.aboutButton},"about"),new N("https://github.com/dementeyolga",m(_.link,new D(De,"github logo",_.logo),r("Olga Dementey"))))}}class qe extends u{constructor(){super({tagName:"div",className:U.page});s(this,"state",p.getInstance());s(this,"chat");s(this,"main");const e=[r("Fun Chat",U.appName),new te],t=this.state.getValue(n.CurrentUser);y(t)&&e.unshift(r(t.login)),this.chat=new B,this.main=W(U.main,new he,this.chat),this.addChildrenComponents("end",new ee(...e),this.main,new $e),this.initListeners()}initListeners(){this.initOpenChatListener()}initOpenChatListener(){this.element.addEventListener(c.OpenChat,e=>{if(e instanceof CustomEvent){const t=e.detail;typeof t=="string"&&(this.main.removeChildComponent(this.chat),this.chat=new B(t),this.main.addChildrenComponents("end",this.chat))}})}}export{qe as default};
